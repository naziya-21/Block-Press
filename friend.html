<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Block Press - Add Friend</title>
  <link rel="stylesheet" href="style01.css">
</head>
<body>

  <!-- Navbar -->
  <div class="navbar">
    <div class="title"><a href="main.html" style="color: white; text-decoration: none;">Block Press</a></div>
    <div class="buttons">
      <button><a href="friend.html" style="color: white; text-decoration: none;">Friends</a></button>
      <button><a href="chat.html" style="color: white; text-decoration: none;">Chat</a></button>
    </div>
    <div id="wallet-info" style="color: white; margin-left: 20px; font-size: 12px;"></div>
  </div>

  <!-- Main container -->
  <div class="container">
    <h1>Add a Friend</h1>

    <div class="card">
      <h3>Enter Friend Details</h3>
      <input type="text" id="friend-address" placeholder="0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266" style="padding: 10px; margin: 10px 0; width: 100%; border-radius: 5px; border: 1px solid #ccc;">
      <input type="text" id="friend-name" placeholder="jesna" style="padding: 10px; margin: 10px 0; width: 100%; border-radius: 5px; border: 1px solid #ccc;">
      <button class="btn" onclick="handleAddFriend()">Add Friend</button>
      <div id="add-status" style="margin-top: 10px; padding: 5px; display: none;"></div>
    </div>

    <!-- My Friend List -->
    <div class="card" style="margin-top: 30px;">
      <h3>My Friends</h3>
      <button class="btn" onclick="loadFriendList()" style="margin-bottom: 15px;">Load Friend List</button>
      <div id="friend-list" style="margin-top: 15px;">
        <!-- Friends will be loaded here -->
      </div>
    </div>
  </div>

  <!-- Web3 Library -->
  <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
  <!-- Web3 Configuration -->
  <script src="js/web3-config.js"></script>
  
  <script>
    let isConnected = false;

    // Initialize on page load
    window.addEventListener('load', async () => {
      await initBlockchain();
    });

    async function initBlockchain() {
      try {
        isConnected = await window.web3Config.initWeb3();
        
        if (isConnected) {
          const account = window.web3Config.getUserAccount();
          document.getElementById('wallet-info').textContent = `Connected: ${account.substring(0, 6)}...${account.substring(38)}`;
          
          // Check if user is registered
          const registered = await window.web3Config.checkUserExists(account);
          if (!registered) {
            alert('Please create an account first at the main page');
            window.location.href = 'main.html';
          } else {
            // Auto-load friend list
            await loadFriendList();
          }
        }
      } catch (error) {
        console.error('Init error:', error);
      }
    }

    async function handleAddFriend() {
      const address = document.getElementById('friend-address').value.trim();
      const name = document.getElementById('friend-name').value.trim();
      
      if (!address || !address.startsWith('0x')) {
        alert('Please enter a valid Ethereum address');
        return;
      }

      if (!name) {
        alert('Please enter a friend name');
        return;
      }

      if (!isConnected) {
        alert('Please connect to MetaMask first');
        await initBlockchain();
        return;
      }

      try {
        const statusDiv = document.getElementById('add-status');
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'Adding friend to blockchain...';
        statusDiv.style.color = '#ff9800';

        await window.web3Config.addFriend(address, name);
        
        statusDiv.textContent = '✓ Friend added successfully!';
        statusDiv.style.color = '#4caf50';
        
        // Clear inputs
        document.getElementById('friend-address').value = '';
        document.getElementById('friend-name').value = '';
        
        // Reload friend list
        await loadFriendList();
      } catch (error) {
        const statusDiv = document.getElementById('add-status');
        statusDiv.style.display = 'block';
        statusDiv.textContent = '✗ Error: ' + error.message;
        statusDiv.style.color = '#f44336';
        console.error('Add friend error:', error);
      }
    }

    async function loadFriendList() {
      try {
        if (!isConnected) return;
        
        const friendList = await window.web3Config.getMyFriendList();
        const container = document.getElementById('friend-list');
        container.innerHTML = '';
        
        if (friendList.length === 0) {
          container.innerHTML = '<p style="color: #666;">No friends yet. Add a friend above!</p>';
          return;
        }
        
        friendList.forEach((friend, index) => {
          const friendDiv = document.createElement('div');
          friendDiv.style.cssText = 'padding: 15px; margin: 10px 0; background: #f5f5f5; border-radius: 5px; border-left: 4px solid #4caf50;';
          friendDiv.innerHTML = `
            <strong>${friend.name}</strong>
            <p style="margin: 5px 0; font-size: 12px; color: #666;">${friend.pubkey}</p>
            <button class="btn" onclick="window.location.href='chat.html?recipient=${friend.pubkey}'" style="margin-top: 10px; padding: 5px 15px; font-size: 12px;">Chat</button>
          `;
          container.appendChild(friendDiv);
        });
      } catch (error) {
        console.error('Load friend list error:', error);
        document.getElementById('friend-list').innerHTML = '<p style="color: #f44336;">Error loading friends: ' + error.message + '</p>';
      }
    }

    // Update UI when blockchain state changes
    window.updateBlockchainUI = async () => {
      await initBlockchain();
      await loadFriendList();
    };
  </script>

</body>
</html>
